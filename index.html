<!DOCTYPE html>
<html lang="tr">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;"
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>At√∂lye Takip V9 (Tarihli)</title>
    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 80px; }
        
        .box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        input, select { width: 100%; padding: 14px; margin: 6px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }
        input:focus { border-color: var(--p); outline: none; }
        
        button { width: 100%; border: none; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; }
        .btn-save { background: var(--s); color: white; }
        .btn-del { background: var(--d); color: white; }
        .btn-back { background: #333; color: white; margin-bottom: 15px; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-jpg { background: var(--p); color: white; }
        
        .folder-header { background: #e9ecef; color: #495057; padding: 10px; font-weight: bold; border-radius: 6px; margin-top: 20px; border-left: 5px solid var(--p); }
        .item-card { background: white; border-radius: 10px; padding: 15px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ccc; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .item-info h4 { margin: 0 0 5px 0; color: #333; }
        .item-info p { margin: 0; color: #666; font-size: 14px; }
        
        #page-detail { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 999; overflow-y: auto; padding: 15px; box-sizing: border-box; }
        .detail-img { width: 100%; border-radius: 10px; margin: 15px 0; border: 1px solid #ddd; }
        .detail-row { background: white; padding: 15px; border-radius: 8px; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        
        #preview { width: 100%; height: 150px; object-fit: contain; border: 2px dashed #ccc; margin-top: 10px; display: none; }
        #loader { display: none; text-align: center; padding: 10px; color: var(--p); font-weight: bold; }
    </style>
</head>
<body>

<div id="page-main">
    <div class="box">
        <h3 id="lbl-title" style="margin-top:0; text-align:center; color:var(--p)">YENƒ∞ ƒ∞≈û KAYDI</h3>
        <input type="hidden" id="inp-id">
        
        <label style="font-size:13px; color:#666; font-weight:bold;">Geli≈ü Tarihi:</label>
        <input type="date" id="inp-date">
        
        <input type="text" id="inp-k" list="list-folders" placeholder="üìÇ Klas√∂r Adƒ± (√ñrn: Ahmet Bey)">
        <datalist id="list-folders"></datalist>
        
        <input type="text" id="inp-u" placeholder="üè∑Ô∏è √úr√ºn Adƒ± (Zorunlu)">
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="inp-c" placeholder="‚≠ï √áap">
            <input type="text" id="inp-b" placeholder="üìè Boy">
        </div>
        
        <input type="text" id="inp-m" placeholder="üõ†Ô∏è Malzeme">
        
        <label style="font-size:14px; font-weight:bold; color:#555; display:block; margin-top:10px;">üì∏ Resim Ekle:</label>
        <input type="file" id="inp-f" accept="image/*" onchange="handleFileSelect(event)">
        <img id="preview">
        
        <div id="loader">Resim i≈üleniyor...</div>
        
        <button class="btn-save" id="btn-submit" onclick="saveItem()">KAYDET</button>
        <button id="btn-cancel" onclick="resetForm()" style="background:#6c757d; color:white; display:none;">ƒ∞PTAL ET</button>
    </div>

    <div class="box" style="position:sticky; top:0; z-index:90;">
        <input type="text" id="inp-search" onkeyup="renderList()" placeholder="üîç Ara...">
    </div>

    <div id="list-container"></div>
</div>

<div id="page-detail">
    <button class="btn-back" onclick="showMain()">‚¨ÖÔ∏è GERƒ∞ D√ñN</button>
    <h2 id="det-title" style="margin-top:0;"></h2>
    
    <div class="detail-row"><b>üìÖ Geli≈ü Tarihi:</b> <span id="det-date"></span></div>
    <div class="detail-row"><b>üìÇ Klas√∂r:</b> <span id="det-folder"></span></div>
    <div class="detail-row"><b>‚≠ï √ñl√ß√ºler:</b> <span id="det-dims"></span></div>
    <div class="detail-row"><b>üõ†Ô∏è Malzeme:</b> <span id="det-mat"></span></div>
    
    <img id="det-img" class="detail-img" style="display:none">
    
    <button class="btn-jpg" onclick="downloadJPG()">üñºÔ∏è RESƒ∞MLƒ∞ KART ƒ∞NDƒ∞R (JPG)</button>
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn-edit" onclick="editItem()">‚úèÔ∏è D√úZENLE</button>
        <button class="btn-del" onclick="deleteItem()">üóëÔ∏è Sƒ∞L</button>
    </div>
</div>

<script>
    // --- VERƒ∞TABANI ---
    // Eƒüer eski veriler (V8) varsa onlarƒ± da alƒ±r
    let db = JSON.parse(localStorage.getItem('AtolyeDB_V8')) || [];
    let currentImageBase64 = null;
    let detailId = null;

    // --- BA≈ûLANGI√á AYARLARI ---
    // Sayfa a√ßƒ±lƒ±nca tarih kutusuna bug√ºn√ºn tarihini bas
    document.getElementById('inp-date').valueAsDate = new Date();

    // --- RESƒ∞M ƒ∞≈ûLEME (Sƒ±kƒ±≈ütƒ±rma) ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        document.getElementById('loader').style.display = 'block';
        document.getElementById('btn-submit').disabled = true;

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const maxSize = 800; // Max boyut

                if (width > height) {
                    if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                } else {
                    if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                currentImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                
                document.getElementById('preview').src = currentImageBase64;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
                document.getElementById('btn-submit').disabled = false;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // --- KAYDETME ---
    function saveItem() {
        const id = document.getElementById('inp-id').value;
        const u = document.getElementById('inp-u').value.trim();
        const k = document.getElementById('inp-k').value.trim() || "Genel";
        let c = document.getElementById('inp-c').value.trim();
        const b = document.getElementById('inp-b').value.trim();
        const m = document.getElementById('inp-m').value.trim();
        const d = document.getElementById('inp-date').value; // YYYY-MM-DD formatƒ±nda gelir

        if (!u) { alert("L√ºtfen √úr√ºn Adƒ± giriniz!"); return; }
        if (c && !c.startsWith('√ò')) c = '√ò' + c;

        const newItem = {
            id: id || Date.now().toString(),
            u: u, k: k, c: c, b: b, m: m,
            dateRaw: d, // D√ºzenleme ve sƒ±ralama i√ßin ham tarih
            img: currentImageBase64
        };

        try {
            if (id) {
                const index = db.findIndex(x => x.id === id);
                if (currentImageBase64 === null) newItem.img = db[index].img;
                db[index] = newItem;
            } else {
                db.push(newItem);
            }

            localStorage.setItem('AtolyeDB_V8', JSON.stringify(db));
            alert("Kayƒ±t Ba≈üarƒ±lƒ±!");
            resetForm();
            renderList();
        } catch (e) {
            alert("Hata: Hafƒ±za dolu olabilir. Gereksiz kayƒ±tlarƒ± silin.");
        }
    }

    // --- FORM TEMƒ∞ZLEME ---
    function resetForm() {
        document.getElementById('inp-id').value = "";
        document.getElementById('inp-u').value = "";
        document.getElementById('inp-c').value = "";
        document.getElementById('inp-b').value = "";
        document.getElementById('inp-m').value = "";
        document.getElementById('inp-f').value = "";
        document.getElementById('inp-date').valueAsDate = new Date(); // Tarihi bug√ºne √ßek
        document.getElementById('preview').style.display = 'none';
        document.getElementById('lbl-title').innerText = "YENƒ∞ ƒ∞≈û KAYDI";
        document.getElementById('btn-submit').innerText = "KAYDET";
        document.getElementById('btn-cancel').style.display = "none";
        currentImageBase64 = null;
    }

    // --- Lƒ∞STELEME ---
    function renderList() {
        const container = document.getElementById('list-container');
        const searchVal = document.getElementById('inp-search').value.toLowerCase();
        const datalist = document.getElementById('list-folders');
        
        container.innerHTML = "";
        datalist.innerHTML = "";

        const folders = [...new Set(db.map(item => item.k))].sort();
        folders.forEach(f => {
            const option = document.createElement('option');
            option.value = f;
            datalist.appendChild(option);
        });

        folders.forEach(folderName => {
            const items = db.filter(item => item.k === folderName && (item.u.toLowerCase().includes(searchVal) || item.k.toLowerCase().includes(searchVal)));
            
            if (items.length > 0) {
                const titleDiv = document.createElement('div');
                titleDiv.className = 'folder-header';
                titleDiv.innerText = `üìÇ ${folderName}`;
                container.appendChild(titleDiv);

                items.slice().reverse().forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.onclick = () => openDetail(item.id);
                    // Tarihi d√ºzg√ºn g√∂ster
                    const tarihGoster = item.dateRaw ? formatDateTR(item.dateRaw) : (item.date || '-');
                    
                    card.innerHTML = `
                        <div class="item-info">
                            <h4>${item.u}</h4>
                            <p>${tarihGoster} | ${item.c || '-'} x ${item.b || '-'}</p>
                        </div>
                        <div style="font-size:20px;">üëâ</div>
                    `;
                    container.appendChild(card);
                });
            }
        });
    }

    // --- YARDIMCI: TARƒ∞H FORMATLAYICI ---
    function formatDateTR(dateString) {
        if(!dateString) return "";
        const parts = dateString.split('-'); // 2024-10-14
        if(parts.length !== 3) return dateString;
        return `${parts[2]}.${parts[1]}.${parts[0]}`; // 14.10.2024
    }

    // --- DETAY & D√úZENLEME ---
    function openDetail(id) {
        detailId = id;
        const item = db.find(x => x.id === id);
        if(!item) return;

        document.getElementById('det-title').innerText = item.u;
        document.getElementById('det-folder').innerText = item.k;
        document.getElementById('det-dims').innerText = `${item.c || ''} x ${item.b || ''}`;
        document.getElementById('det-mat').innerText = item.m || '';
        
        // Detayda tarihi g√∂ster
        const tarihGoster = item.dateRaw ? formatDateTR(item.dateRaw) : (item.date || '-');
        document.getElementById('det-date').innerText = tarihGoster;

        const imgElem = document.getElementById('det-img');
        if (item.img) {
            imgElem.src = item.img;
            imgElem.style.display = 'block';
        } else {
            imgElem.style.display = 'none';
        }

        document.getElementById('page-main').style.display = 'none';
        document.getElementById('page-detail').style.display = 'block';
    }

    function showMain() {
        document.getElementById('page-detail').style.display = 'none';
        document.getElementById('page-main').style.display = 'block';
    }

    function deleteItem() {
        if(confirm("Silmek istediƒüine emin misin?")) {
            db = db.filter(x => x.id !== detailId);
            localStorage.setItem('AtolyeDB_V8', JSON.stringify(db));
            showMain();
            renderList();
        }
    }

    function editItem() {
        const item = db.find(x => x.id === detailId);
        showMain();
        
        document.getElementById('inp-id').value = item.id;
        document.getElementById('inp-k').value = item.k;
        document.getElementById('inp-u').value = item.u;
        document.getElementById('inp-c').value = item.c ? item.c.replace('√ò', '') : '';
        document.getElementById('inp-b').value = item.b;
        document.getElementById('inp-m').value = item.m;
        
        // Tarihi kutuya geri y√ºkle (YYYY-MM-DD formatƒ±nda olmalƒ±)
        if(item.dateRaw) {
            document.getElementById('inp-date').value = item.dateRaw;
        }

        if (item.img) {
            document.getElementById('preview').src = item.img;
            document.getElementById('preview').style.display = 'block';
            currentImageBase64 = null; 
        } else {
            document.getElementById('preview').style.display = 'none';
        }

        document.getElementById('lbl-title').innerText = "KAYDI D√úZENLE";
        document.getElementById('btn-submit').innerText = "G√úNCELLEMEYƒ∞ KAYDET";
        document.getElementById('btn-cancel').style.display = "block";
        window.scrollTo(0,0);
    }

    // --- JPG ƒ∞NDƒ∞RME ---
    function downloadJPG() {
        const item = db.find(x => x.id === detailId);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = 800;
        canvas.height = 1100;
        
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#1a73e8"; 
        ctx.font = "bold 40px Arial";
        ctx.fillText("ƒ∞≈û TAKƒ∞P KARTI", 50, 80);
        
        const tarihGoster = item.dateRaw ? formatDateTR(item.dateRaw) : (item.date || '-');

        ctx.fillStyle = "#000";
        ctx.font = "bold 30px Arial";
        ctx.fillText("√úr√ºn Adƒ±: " + item.u, 50, 150);
        
        ctx.font = "24px Arial";
        ctx.fillStyle = "#333";
        ctx.fillText("Geli≈ü Tarihi: " + tarihGoster, 50, 200);
        ctx.fillText("Klas√∂r: " + item.k, 50, 240);
        ctx.fillText("√ñl√ß√ºler: " + (item.c||'-') + " x " + (item.b||'-'), 50, 280);
        ctx.fillText("Malzeme: " + (item.m||'-'), 50, 320);

        ctx.beginPath();
        ctx.moveTo(50, 350);
        ctx.lineTo(750, 350);
        ctx.strokeStyle = "#ccc";
        ctx.stroke();

        if (item.img) {
            const img = new Image();
            img.onload = function() {
                const maxWidth = 700;
                const maxHeight = 650;
                let w = img.width;
                let h = img.height;
                const ratio = Math.min(maxWidth / w, maxHeight / h);
                w = w * ratio;
                h = h * ratio;
                const x = 50 + (maxWidth - w) / 2;
                ctx.drawImage(img, x, 380, w, h);
                saveCanvas(canvas, item.u);
            };
            img.src = item.img;
        } else {
            ctx.font = "italic 20px Arial";
            ctx.fillStyle = "#999";
            ctx.fillText("(G√∂rsel Yok)", 50, 400);
            saveCanvas(canvas, item.u);
        }
    }

    function saveCanvas(canvas, name) {
        const link = document.createElement('a');
        link.download = name + "_Kart.jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.9);
        link.click();
    }

    renderList();

</script>
</body>
</html>
